name: PE
version: $SERVICE_TAG
description: >-
  This service extracts attributes (imports, exports, section names, ...)
  from windows PE files using the python library LIEF.

accepts: executable/windows
rejects: empty|metadata/.*

stage: CORE
category: Static Analysis

file_required: true
timeout: 60
disable_cache: false

enabled: true
is_external: false
licence_count: 0

config:
  trusted_certs: ["/usr/share/ca-certificates/mozilla/"]
  hash_generation_max_size: 5000000
  heur11_allowed_timestamp_range: 86400
  heur22_flag_more_recent_than_days: 3
  heur24_allowed_mismatch_file_size: 0.25

heuristics:
  - description: >-
      Signature data found in PE but doesn't match the content.
      This is either due to malicious copying of signature data or
      an error in transmission.
    filetype: "executable/windows"
    heur_id: 1
    name: Invalid Signature
    score: 300

  - description: This PE appears to have a legitimate signature.
    filetype: "executable/windows"
    heur_id: 2
    name: Signed EXE
    score: 0

  - description: This PE appears is self-signed. All certificates are from the same issuer.
    filetype: "executable/windows"
    heur_id: 3
    name: Same issuer for all certificates
    score: 500

  - description: >-
      This PE contains at least one section with entropy > 7.5, which
      may indicate packed or encrypted code.

      (see: http://n10info.blogspot.com/2014/06/entropy-and-distinctive-signs-of-packed.html)
    filetype: "executable/windows"
    heur_id: 4
    name: High section entropy
    score: 100

  - description: >-
      This PE may be self signed. A chain of trust back to a known root CA was not found
      however certificates presented had different issuers.
    filetype: "executable/windows"
    heur_id: 5
    name: Unknown Root CA
    score: 100

  - description: This PE is signed by a certificate which is signed by itself
    filetype: "executable/windows"
    heur_id: 6
    name: Self-signed certificate
    score: 500

  - description: This file looks like a PE file but fails to load
    filetype: "executable/windows"
    heur_id: 7
    name: Invalid PE look-alike
    score: 100

  - description: This file has less than two certificate. This is probably an error...
    filetype: "executable/windows"
    heur_id: 8
    name: Less than two certificates found
    score: 50

  - description: >-
       The signature has an invalid encryption algorithm set therefore cannot be decode. This is
       usually a sign of someone tampering with the signature information.
    filetype: "executable/windows"
    heur_id: 9
    name: Invalid encryption algorithm used for signature
    score: 1000

  - description: >-
       The signature has an invalid signature due to being unable to parse the signer information.
    filetype: "executable/windows"
    heur_id: 10
    name: Invalid Signature due to invalid Signer
    score: 300

  - description: >-
       Multiple different non-zero timestamps were found compiled in the binary.
    filetype: "executable/windows"
    heur_id: 11
    name: Multiple different non-zero timestamps
    score: 250

  - description: >-
       At least one resource was detected as an executable.
    filetype: "executable/windows"
    heur_id: 12
    name: Executable in resources
    score: 800

  - description: >-
       This file contains heavily corrupted resources.
    filetype: "executable/windows"
    heur_id: 13
    name: Corrupted resources
    score: 200

  - description: >-
       Section could not be retrieved using the section's name.
    filetype: "executable/windows"
    heur_id: 14
    name: Irretrievable section
    score: 400

  - description: >-
       Some resources directories does not contain any data.
    filetype: "executable/windows"
    heur_id: 15
    name: Dataless resources
    score: 200

  - description: >-
       Unreadable PDB filename.
    filetype: "executable/windows"
    heur_id: 16
    name: Corrupted PDB filename
    score: 400

  - description: >-
       Invalid authentihash.
    filetype: "executable/windows"
    heur_id: 17
    name: Invalid authentihash
    score: 200

  - description: >-
       Invalid Magic.
    filetype: "executable/windows"
    heur_id: 18
    name: Invalid Magic
    score: 100

  - description: >-
       A PE file with no section is higly suspicious, or corrupted.
    filetype: "executable/windows"
    heur_id: 19
    name: No section found
    score: 100

  - description: >-
       A section name that is commonly found among packed binaries, but is not necessarily a direct correlation to maliciousness.
    filetype: "executable/windows"
    heur_id: 20
    name: Common packed section name
    score: 100

  - description: >-
       A section name that is almost never found among benign samples.
    filetype: "executable/windows"
    heur_id: 21
    name: Malicious section name
    score: 250

  - description: >-
       A timestamp found in the PE is very recent or in the future. It may be the latest version of a genuine software, or a custom built executable for a targeted execution.
    filetype: "executable/windows"
    heur_id: 22
    name: Recent timestamp found
    score: 500

  - description: >-
       The checksum found in the optional header is not equivalent to the computed checksum. Microsoft does not enforce validation of this checksum outside of kernel drivers use.
    filetype: "executable/windows"
    heur_id: 23
    name: Invalid optional header checksum
    score: 200

  - description: >-
       The file size is very different from the reported virtual size.
    filetype: "executable/windows"
    heur_id: 24
    name: Mismatch file size
    score: 100

docker_config:
  image: ${REGISTRY}cccs/assemblyline-service-pe:$SERVICE_TAG
  cpu_cores: 1
  ram_mb: 512
